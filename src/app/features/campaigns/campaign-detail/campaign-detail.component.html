<!-- Affiche un message de chargement pendant la récupération des données -->
<div *ngIf="isLoading" class="flex justify-center items-center h-screen">
  <div class="text-center text-xl text-gray-400">Chargement de la campagne...</div>
</div>

<!-- Affiche le contenu principal une fois la campagne chargée -->
<div *ngIf="!isLoading && campaign" class="container mx-auto p-4 md:p-8">

  <!-- Le formulaire englobe les sections modifiables -->
  <form [formGroup]="campaignForm" (ngSubmit)="saveChanges()">
    <!-- En-tête avec le nom de la campagne et les boutons d'action -->
    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
      <div>
        <!-- Affichage du nom en mode lecture -->
        <h1 *ngIf="!isEditMode" class="text-4xl font-bold font-serif text-blue-400">{{ campaign.name }}</h1>
        <!-- Champ de saisie pour le nom en mode édition -->
        <input *ngIf="isEditMode" formControlName="name" class="text-4xl font-bold font-serif bg-slate-700/80 text-blue-300 p-2 rounded-lg outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      <!-- Boutons d'action pour le MJ -->
      <div class="flex space-x-2">
        <button *ngIf="isGameMaster && !isEditMode" type="button" (click)="enterEditMode()" class="bg-purple-600 text-white font-bold px-4 py-2 rounded-lg hover:bg-purple-500 transition-colors">Modifier</button>
        <button *ngIf="isGameMaster && isEditMode" type="submit" [disabled]="campaignForm.invalid" class="bg-purple-600 text-white font-bold px-4 py-2 rounded-lg hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Enregistrer</button>
        <button *ngIf="isGameMaster && isEditMode" type="button" (click)="cancelEdit()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition-colors">Annuler</button>
        <button *ngIf="isGameMaster" type="button" (click)="deleteCampaign()" class="bg-red-700 text-white font-bold px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Supprimer</button>
      </div>
    </div>

    <!-- Grille principale pour l'organisation du contenu -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Colonne de gauche avec les informations et les participants -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Carte d'informations générales -->
        <div class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-lg shadow-xl shadow-black/30 border border-blue-400/30">
          <h2 class="text-2xl font-bold font-serif text-blue-300 mb-4">Informations</h2>
          <!-- Description -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Description</label>
            <p *ngIf="!isEditMode" class="text-gray-300 whitespace-pre-line">{{ campaign.description }}</p>
            <textarea *ngIf="isEditMode" formControlName="description" rows="6" class="w-full p-2 bg-slate-900/70 border border-slate-600 rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
          </div>
          <!-- Maître du Jeu -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Maître du Jeu</label>
            <p *ngIf="!isEditMode" class="text-purple-300 font-semibold">{{ campaign.gameMaster.pseudo }}</p>
            <!-- Sélecteur pour changer de MJ en mode édition -->
            <select *ngIf="isEditMode" formControlName="gameMasterId" class="w-full p-2 bg-slate-900/70 border border-slate-600 rounded-md text-gray-200">
              <option [value]="campaign.gameMaster.id">{{ campaign.gameMaster.pseudo }} (Actuel)</option>
              <ng-container *ngFor="let player of campaign.campaignPlayers">
                <option *ngIf="player.id !== campaign.gameMaster.id" [value]="player.id">{{ player.pseudo }}</option>
              </ng-container>
            </select>
          </div>
        </div>

        <!-- Carte des participants -->
        <div class="bg-slate-800/50 p-6 rounded-lg shadow-xl shadow-black/30 border border-blue-400/30">
          <h2 class="text-2xl font-bold font-serif text-blue-300 mb-4">Participants</h2>

          <!-- Section pour ajouter un joueur (visible par le MJ) -->
          <div *ngIf="isGameMaster" class="mb-4">
            <p class="text-sm text-gray-400 mb-2">Ajouter un joueur depuis votre liste d'amis :</p>
            <div class="flex gap-2">
              <!-- CORRECTION: Appel de la méthode du composant -->
              <select
                (change)="onFriendSelected($event)"
                [value]="selectedFriendIdToAdd || ''"
                class="flex-grow p-2 bg-slate-900/70 border border-slate-600 rounded-md text-gray-200"
                [class.text-gray-500]="!selectedFriendIdToAdd">
                <option [ngValue]="null" disabled [selected]="!selectedFriendIdToAdd">Choisir un ami...</option>
                <option *ngFor="let friend of availableFriends" [value]="friend.id">{{ friend.pseudo }}</option>
                <option *ngIf="availableFriends.length === 0" disabled>Aucun ami à ajouter</option>
              </select>
              <!-- Le bouton est lié à la méthode addPlayer() -->
              <button
                type="button"
                (click)="addPlayer()"
                [disabled]="!selectedFriendIdToAdd"
                class="px-3 bg-purple-600 rounded-lg text-white font-bold hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">+</button>
            </div>
          </div>

          <!-- Liste des participants avec accès sécurisé (?. ) -->
          <ul class="space-y-2">
            <!-- Affichage spécial pour le Maître du Jeu -->
            <li class="flex justify-between items-center bg-slate-900/50 p-2 rounded-md">
              <span class="text-purple-300 font-semibold">{{ campaign.gameMaster.pseudo }} (MJ)</span>
            </li>
            <!-- Liste des autres joueurs -->
            <ng-container *ngFor="let player of campaign.campaignPlayers">
              <!-- On n'affiche le joueur que s'il n'est pas le MJ -->
              <li *ngIf="player.id !== campaign.gameMaster.id" class="flex justify-between items-center bg-slate-900/50 p-2 rounded-md">
                <span class="text-gray-200">{{ player.pseudo }}</span>
                <!-- Bouton de retrait -->
                <button
                  *ngIf="isGameMaster"
                  (click)="removePlayer(player.id)"
                  class="text-red-500 hover:text-red-400 text-xs font-semibold">Retirer</button>
              </li>
            </ng-container>
          </ul>
        </div>

        <!-- ... (partie supérieure du template, jusqu'à la carte des participants) ... -->

        <!-- Carte des personnages (MISE À JOUR) -->
        <div class="bg-slate-800/50 p-6 rounded-lg shadow-xl shadow-black/30 border border-blue-400/30">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold font-serif text-blue-300">Personnages</h2>
            <!-- Bouton pour qu'un joueur ajoute son personnage, s'il n'en a pas -->
            <button *ngIf="canAddCharacter" (click)="navigateToAddCharacter()"
                    class="bg-purple-600 text-white text-sm font-bold px-3 py-1 rounded-lg hover:bg-purple-500 transition-colors">
              Ajouter
            </button>
          </div>

          <!-- Message si aucun personnage n'est dans la campagne -->
          <div *ngIf="campaign && campaign.campaignOgl5CharacterSheets.length === 0 && campaign.campaignCustomCharacterSheets.length === 0" class="text-gray-400 text-sm">
            Aucun personnage n'a encore rejoint cette campagne.
          </div>

          <!-- SECTION POUR LES PERSONNAGES OGL 5 -->
          <div *ngIf="campaign && campaign.campaignOgl5CharacterSheets.length > 0">
            <h3 class="text-lg font-semibold text-purple-300 mt-4 mb-2 border-b border-purple-500/30 pb-1">Personnages OGL 5</h3>
            <ul class="space-y-2">
              <li *ngFor="let char of campaign.campaignOgl5CharacterSheets"
                  class="flex flex-wrap justify-between items-center bg-slate-900/50 p-3 rounded-md gap-2">
                <!-- Nom du personnage et du joueur (pour le MJ) -->
                <div class="flex-grow">
                  <span class="font-semibold text-gray-200">{{ char.name }}</span>
                  <span *ngIf="isGameMaster" class="text-xs text-purple-400 ml-2">({{ char.owner.pseudo }})</span>
                </div>
                <!-- Actions sur le personnage -->
                <div class="flex items-center space-x-3">
                  <a *ngIf="isGameMaster || char.owner.id === currentUserId" [routerLink]="['/characters/detail', 'ogl5', char.id]" class="text-blue-400 hover:text-blue-300 text-sm font-semibold">Voir la fiche</a>
                  <button *ngIf="isGameMaster || char.owner.id === currentUserId" (click)="removeCharacter(char.id, 'ogl5')" class="text-red-500 hover:text-red-400 text-xs font-semibold">Retirer</button>
                </div>
              </li>
            </ul>
          </div>

          <!-- SECTION POUR LES PERSONNAGES CUSTOM -->
          <div *ngIf="campaign && campaign.campaignCustomCharacterSheets.length > 0">
            <h3 class="text-lg font-semibold text-purple-300 mt-4 mb-2 border-b border-purple-500/30 pb-1">Personnages Personnalisés</h3>
            <ul class="space-y-2">
              <li *ngFor="let char of campaign.campaignCustomCharacterSheets"
                  class="flex flex-wrap justify-between items-center bg-slate-900/50 p-3 rounded-md gap-2">
                <!-- Nom du personnage et du joueur (pour le MJ) -->
                <div class="flex-grow">
                  <span class="font-semibold text-gray-200">{{ char.name }}</span>
                  <span *ngIf="isGameMaster" class="text-xs text-purple-400 ml-2">({{ char.owner.pseudo }})</span>
                </div>
                <!-- Actions sur le personnage -->
                <div class="flex items-center space-x-3">
                  <a *ngIf="isGameMaster || char.owner.id === currentUserId" [routerLink]="['/characters/detail', 'custom', char.id]" class="text-blue-400 hover:text-blue-300 text-sm font-semibold">Voir la fiche</a>
                  <button *ngIf="isGameMaster || char.owner.id === currentUserId" (click)="removeCharacter(char.id, 'custom')" class="text-red-500 hover:text-red-400 text-xs font-semibold">Retirer</button>
                </div>
              </li>
            </ul>
          </div>
        </div>
      <!-- ... (reste du template) ... -->

      </div>

      <!-- Colonne de droite pour les notes de campagne -->
      <div class="lg:col-span-2">
        <!-- Accès sécurisé à campaign.id -->
        <app-campaign-notes [campaignId]="campaign.id"></app-campaign-notes>
      </div>
    </div>
  </form>
</div>
